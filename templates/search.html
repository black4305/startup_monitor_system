{% extends "base.html" %}

{% block title %}ì§€ì›ì‚¬ì—… ê²€ìƒ‰ - AI ì§€ì›ì‚¬ì—… ëª¨ë‹ˆí„°ë§{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-search"></i> ì§€ì›ì‚¬ì—… ê²€ìƒ‰</h1>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <!-- ë°°ì¹˜ ì§„í–‰ ìƒí™© -->
                <div id="batchProgress" class="mb-4">
                    <h5><i class="fas fa-tasks"></i> ë°°ì¹˜ ì²˜ë¦¬ ìƒí™©</h5>
                    <div class="progress mb-2">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progressText" class="text-muted">ë°°ì¹˜ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
                </div>
                
                <!-- ê²€ìƒ‰ ë²„íŠ¼ë“¤ -->
                <div class="mb-3">
                    <button id="searchBtn" class="btn btn-primary btn-lg me-2" onclick="startSearch()">
                        <i class="fas fa-search"></i> AI ê²€ìƒ‰ ì‹œì‘
                    </button>
                    <button id="nextBatchBtn" class="btn btn-success btn-lg me-2" onclick="runNextBatch()" disabled>
                        <i class="fas fa-forward"></i> ë‹¤ìŒ ë°°ì¹˜ ì‹¤í–‰
                    </button>
                    <button id="refreshBtn" class="btn btn-info btn-lg" onclick="refreshProgress()">
                        <i class="fas fa-sync-alt"></i> ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                
                <div id="searchProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="mt-2">ğŸ¤– AIê°€ ì§€ì›ì‚¬ì—…ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
                
                <div id="searchResults" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentBatchInfo = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ì¹˜ ì§„í–‰ ìƒí™© í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    refreshProgress();
});

async function refreshProgress() {
    try {
        const response = await fetch('/api/batch/progress');
        const progress = await response.json();
        
        if (progress.error) {
            document.getElementById('progressText').textContent = `ì˜¤ë¥˜: ${progress.error}`;
            return;
        }
        
        currentBatchInfo = progress;
        updateProgressDisplay(progress);
        
    } catch (error) {
        document.getElementById('progressText').textContent = `ì§„í–‰ ìƒí™© ì¡°íšŒ ì‹¤íŒ¨: ${error}`;
    }
}

function updateProgressDisplay(progress) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const nextBatchBtn = document.getElementById('nextBatchBtn');
    
    const percentage = progress.progress_percentage || 0;
    progressBar.style.width = `${percentage}%`;
    progressBar.textContent = `${percentage.toFixed(1)}%`;
    
    progressText.innerHTML = `
        ğŸ“Š ì „ì²´ ${progress.total_sites}ê°œ ì‚¬ì´íŠ¸ ì¤‘ ${progress.completed_batches * progress.batch_size}ê°œ ì™„ë£Œ<br>
        ğŸ”„ ë°°ì¹˜ ${progress.completed_batches}/${progress.total_batches} ì™„ë£Œ (ë°°ì¹˜ë‹¹ ${progress.batch_size}ê°œ ì‚¬ì´íŠ¸)
    `;
    
    // ë‹¤ìŒ ë°°ì¹˜ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    if (progress.completed_batches < progress.total_batches) {
        nextBatchBtn.disabled = false;
        nextBatchBtn.innerHTML = `<i class="fas fa-forward"></i> ë°°ì¹˜ ${progress.completed_batches + 1} ì‹¤í–‰`;
    } else {
        nextBatchBtn.disabled = true;
        nextBatchBtn.innerHTML = `<i class="fas fa-check"></i> ëª¨ë“  ë°°ì¹˜ ì™„ë£Œ`;
    }
}

async function startSearch() {
    const searchBtn = document.getElementById('searchBtn');
    const searchProgress = document.getElementById('searchProgress');
    const searchResults = document.getElementById('searchResults');
    
    searchBtn.disabled = true;
    searchProgress.style.display = 'block';
    searchResults.innerHTML = '';
    
    try {
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.error) {
            searchResults.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
        } else {
            displayResults(result);
            // ê²€ìƒ‰ í›„ ë°°ì¹˜ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            refreshProgress();
        }
    } catch (error) {
        searchResults.innerHTML = `<div class="alert alert-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</div>`;
    } finally {
        searchBtn.disabled = false;
        searchProgress.style.display = 'none';
    }
}

async function runNextBatch() {
    const nextBatchBtn = document.getElementById('nextBatchBtn');
    const searchResults = document.getElementById('searchResults');
    
    nextBatchBtn.disabled = true;
    nextBatchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë°°ì¹˜ ì‹¤í–‰ ì¤‘...';
    
    try {
        const response = await fetch('/api/batch/next', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            searchResults.innerHTML = `
                <div class="alert alert-success">
                    <h5>âœ… ${result.message}</h5>
                    <p>ë°°ì¹˜ ${result.batch_number}: ${result.programs_found}ê°œ ì§€ì›ì‚¬ì—… ë°œê²¬</p>
                </div>
            `;
            
            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            refreshProgress();
            
            // í†µí•© ê²°ê³¼ ë¡œë“œ
            loadCombinedResults();
            
        } else if (result.status === 'completed') {
            searchResults.innerHTML = `
                <div class="alert alert-info">
                    <h5>ğŸ‰ ${result.message}</h5>
                </div>
            `;
            refreshProgress();
            loadCombinedResults();
            
        } else {
            searchResults.innerHTML = `
                <div class="alert alert-danger">
                    <h5>âŒ ë°°ì¹˜ ì‹¤í–‰ ì‹¤íŒ¨</h5>
                    <p>${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
        
    } catch (error) {
        searchResults.innerHTML = `<div class="alert alert-danger">ë°°ì¹˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: ${error}</div>`;
    } finally {
        nextBatchBtn.disabled = false;
        refreshProgress();
    }
}

async function loadCombinedResults() {
    try {
        const response = await fetch('/api/batch/results');
        const result = await response.json();
        
        if (result.error) {
            console.error('í†µí•© ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', result.error);
            return;
        }
        
        if (result.programs && result.programs.length > 0) {
            displayBatchResults(result);
        }
        
    } catch (error) {
        console.error('í†µí•© ê²°ê³¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
    }
}

function displayResults(result) {
    const searchResults = document.getElementById('searchResults');
    const summary = result.summary || {};
    const recommendations = result.top_recommendations || [];
    const batchInfo = result.batch_info || {};
    
    let html = `
        <div class="alert alert-success">
            <h5>âœ… ê²€ìƒ‰ ì™„ë£Œ!</h5>
            <p>ì´ ${summary.total_programs || 0}ê°œ ì§€ì›ì‚¬ì—… ë°œê²¬</p>
            <p>í˜„ì¬ ì •í™•ë„: <strong>${result.current_accuracy || 0}%</strong></p>
            ${batchInfo.total_batches ? `<p>ë°°ì¹˜ ì§„í–‰: ${batchInfo.completed_batches}/${batchInfo.total_batches}</p>` : ''}
        </div>
    `;
    
    if (recommendations.length > 0) {
        html += '<h5>ğŸ† ìƒìœ„ ì¶”ì²œ ì§€ì›ì‚¬ì—…:</h5>';
        recommendations.forEach((rec, index) => {
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${rec.title}</h6>
                        <p class="card-text">${rec.content ? rec.content.substring(0, 200) + '...' : ''}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-primary">ì ìˆ˜: ${rec.score || rec.enhanced_score}</span>
                                <span class="badge bg-info">${rec.site}</span>
                                ${rec.batch_number ? `<span class="badge bg-secondary">ë°°ì¹˜ ${rec.batch_number}</span>` : ''}
                            </div>
                            <div>
                                <button class="btn btn-success btn-sm" onclick="recordFeedback(${index}, 'keep')">
                                    <i class="fas fa-heart"></i> ê´€ì‹¬ìˆìŒ
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="recordFeedback(${index}, 'delete')">
                                    <i class="fas fa-trash"></i> ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    searchResults.innerHTML = html;
    window.currentResults = recommendations;
}

function displayBatchResults(result) {
    const searchResults = document.getElementById('searchResults');
    const programs = result.programs || [];
    const batchInfo = result.batch_info || {};
    
    let html = `
        <div class="alert alert-info">
            <h5>ğŸ“Š í†µí•© ë°°ì¹˜ ê²°ê³¼</h5>
            <p>ì´ ${result.total_programs}ê°œ ì§€ì›ì‚¬ì—… (ìƒìœ„ ${programs.length}ê°œ í‘œì‹œ)</p>
            <p>ë°°ì¹˜ ì§„í–‰: ${batchInfo.completed_batches}/${batchInfo.total_batches}</p>
        </div>
    `;
    
    if (programs.length > 0) {
        html += '<h5>ğŸ† ìƒìœ„ ì¶”ì²œ ì§€ì›ì‚¬ì—…:</h5>';
        programs.forEach((rec, index) => {
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${rec.title}</h6>
                        <p class="card-text">${rec.content ? rec.content.substring(0, 200) + '...' : ''}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-primary">ì ìˆ˜: ${rec.personalized_score}</span>
                                <span class="badge bg-info">${rec.site_name}</span>
                                <span class="badge bg-secondary">ë°°ì¹˜ ${rec.batch_number}</span>
                            </div>
                            <div>
                                <button class="btn btn-success btn-sm" onclick="recordBatchFeedback(${index}, 'keep')">
                                    <i class="fas fa-heart"></i> ê´€ì‹¬ìˆìŒ
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="recordBatchFeedback(${index}, 'delete')">
                                    <i class="fas fa-trash"></i> ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    searchResults.innerHTML = html;
    window.currentBatchResults = programs;
}

async function recordFeedback(index, action) {
    const program = window.currentResults[index];
    
    try {
        const response = await fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                program_data: program,
                action: action
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`âœ… ${action === 'keep' ? 'ê´€ì‹¬ìˆìŒ' : 'ì‚­ì œ'} í”¼ë“œë°±ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            // í•´ë‹¹ ì¹´ë“œ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.card')[index + 1].style.display = 'none';
        } else {
            alert(`âŒ ì˜¤ë¥˜: ${result.error}`);
        }
    } catch (error) {
        alert(`âŒ í”¼ë“œë°± ê¸°ë¡ ì‹¤íŒ¨: ${error}`);
    }
}

async function recordBatchFeedback(index, action) {
    const program = window.currentBatchResults[index];
    
    try {
        const response = await fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                program_data: program,
                action: action
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`âœ… ${action === 'keep' ? 'ê´€ì‹¬ìˆìŒ' : 'ì‚­ì œ'} í”¼ë“œë°±ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            // í•´ë‹¹ ì¹´ë“œ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.card')[index + 1].style.display = 'none';
        } else {
            alert(`âŒ ì˜¤ë¥˜: ${result.error}`);
        }
    } catch (error) {
        alert(`âŒ í”¼ë“œë°± ê¸°ë¡ ì‹¤íŒ¨: ${error}`);
    }
}
</script>
{% endblock %}